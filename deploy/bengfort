# bengfort
#
# Author:  Benjamin Bengfort
# Created: Tue Aug 05 10:06:49 2014 -0400
#
# Django-Nginx Configuration for Bengfort.com App
# For more details about this configuration, see the Django-handbook

server {
    # Deny illegal Host headers
    server_name _;
    return 444;
}

server {
    # The basics
    listen 80;
    server_tokens off;
    server_name bengfort.com;
    client_max_body_size 3M;

    # Logging
    access_log /var/log/nginx/access_bengfort.log;
    error_log  /var/log/nginx/error_bengfort.log;

    # Locations and Root
    root /var/www/bengfort.com/;

    location / {
        # Checks for static file, if not found, proxy to app
        try_files $uri @django;
    }

    # Maintenance Mode Settings
    error_page 502 503 504 @maintenance;

    location @maintenance {
        # Create a directory in the site static files called "downtime"
        # which should contain a "maintenance.html" file.
        root /var/www/bengfort.com/static/downtime;
        rewrite ^(.*)$ /maintenance.html break;
    }

    # Finally, the Django App!
    location @django {
        # If there is a file called downtime in the public directory, go
        # into maintenance mode and return downtime page if exists.
        if (-f /var/www/downtime) {
            return 503;
        }

        # uWSGI Settings
        uwsgi_pass 127.0.0.1:3212;
        proxy_set_header    Host                $http_host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto   $http_x_forwarded_proto;
        add_header          X-Cache-Status      $upstream_cache_status;

        proxy_redirect off;
        include uwsgi_params;
    }
}
